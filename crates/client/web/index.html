<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
    <title>Native Agar - Rust WASM Client</title>

    <!-- Tailwind CSS generated by build.rs via tailwindcss CLI -->
    <link rel="stylesheet" href="tailwind.css">
</head>
<body class="font-sans overflow-hidden theme-body">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center flex-col z-10000 transition-opacity duration-300">
        <div class="loading-spinner"></div>
        <div class="theme-text text-lg mt-5 font-medium opacity-90">
            Loading<span class="loading-dots"></span>
        </div>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas" class="block w-screen h-screen cursor-crosshair"></canvas>

    <!-- Minimap Canvas -->
    <canvas id="minimapCanvas" class="absolute bottom-2 right-2 rounded pointer-events-none hidden"></canvas>

    <!-- Server Selection (hidden by default) -->
    <div id="serverSelection" class="absolute inset-0 theme-overlay hidden z-60">
        <h2 class="theme-text text-3xl mb-6">Select Server</h2>
        <div id="serverList" class="flex flex-col gap-3 mb-6">
            <!-- Server buttons will be populated by JavaScript -->
        </div>
        <button id="backToLogin" class="py-2 px-6 text-sm border rounded theme-control hover:bg-white/20 transition-colors">
            Back
        </button>
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="absolute inset-0 flex flex-col items-center justify-center z-50 theme-overlay">
        <h1 class="theme-text text-5xl mb-8">Native Agar</h1>
         <input type="text" id="nickInput" placeholder="Enter your name" maxlength="15"
             class="py-4 px-6 text-lg border-2 rounded mb-2 text-center theme-control" />
         <div class="skin-input-wrapper mb-4">
             <input type="text" id="skinInput" placeholder="Skin name (optional)" maxlength="32"
                 class="py-2 px-4 text-sm border rounded text-center theme-control" style="min-width: 240px;" />
             <button id="skinPickerBtn" type="button"
                 class="py-2 px-3 text-sm border rounded theme-control hover:bg-white/20 transition-colors">
                 <svg class="w-4 h-4 fill-white/70" viewBox="0 0 24 24">
                     <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                 </svg>
             </button>
         </div>
        <button id="playButton" disabled
                class="py-4 px-10 text-xl border-0 rounded bg-green-500 text-white cursor-pointer transition-colors duration-300 hover:bg-green-600 disabled:bg-gray-500 disabled:cursor-not-allowed">
            Connecting...
        </button>
        <button id="changeServerButton" class="hidden mt-3 py-2 px-6 text-sm border rounded theme-control hover:bg-white/20 transition-colors">
            Change Server
        </button>
        <!-- Help & Settings Buttons -->
        <div class="flex gap-3 mt-6">
            <!-- Help Button & Popup -->
            <div class="relative">
                <button id="helpBtn" type="button"
                    class="w-10 h-10 rounded-lg border theme-control hover:bg-white/20 flex items-center justify-center cursor-pointer transition-all duration-150">
                    <svg class="w-5 h-5 fill-white/70" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                    </svg>
                </button>

                <!-- Help Popup -->
                <div id="helpPopup"
                     class="absolute bottom-14 left-1/2 -translate-x-1/2 scale-95 opacity-0 invisible
                        backdrop-blur rounded-lg p-4 min-w-80 max-w-96 theme-panel border
                            transition-all duration-150
                            data-[open=true]:scale-100 data-[open=true]:opacity-100 data-[open=true]:visible">

                    <div class="text-[11px] theme-muted uppercase tracking-wider mb-3">Keyboard Controls</div>

                    <div class="space-y-3 text-xs theme-text">
                        <!-- Basic Controls -->
                        <div>
                            <div class="font-semibold mb-1.5 text-white/90">Basic Controls</div>
                            <div class="space-y-1">
                                <div><kbd>Space</kbd> - Split your cells</div>
                                <div><kbd>W</kbd> - Eject mass</div>
                                <div><kbd>Enter</kbd> - Open chat</div>
                                <div><kbd>Escape</kbd> - Return to menu</div>
                            </div>
                        </div>

                        <!-- Minion Controls -->
                        <div>
                            <div class="font-semibold mb-1.5 text-white/90">Minion Controls</div>
                            <div class="text-[10px] theme-muted mb-1.5 italic">Requires minions (use <kbd>/minion</kbd> operator command)</div>
                            <div class="space-y-1">
                                <div><kbd>Q</kbd> - Freeze your main cells</div>
                                <div><kbd>E</kbd> - Make minions split</div>
                                <div><kbd>R</kbd> - Make minions eject</div>
                                <div><kbd>T</kbd> - Freeze minions</div>
                                <div><kbd>P</kbd> - Toggle minion food collection</div>
                            </div>
                        </div>

                        <!-- Useful Commands -->
                        <div>
                            <div class="font-semibold mb-1.5 text-white/90">Useful Chat Commands</div>
                            <div class="space-y-1">
                                <div><kbd>/help</kbd> - Show all commands</div>
                                <div><kbd>/operator &lt;pass&gt;</kbd> - Become operator</div>
                                <div><kbd>/minion [count]</kbd> - Add minions (op)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Button & Popup -->
            <div class="relative">
                <button id="settingsBtn" type="button"
                    class="w-10 h-10 rounded-lg border theme-control hover:bg-white/20 flex items-center justify-center cursor-pointer transition-all duration-150">
                    <svg class="w-5 h-5 fill-white/70" viewBox="0 0 24 24">
                        <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                </button>

                <!-- Settings Popup -->
                <div id="settingsPopup"
                     class="absolute bottom-14 left-1/2 -translate-x-1/2 scale-95 opacity-0 invisible
                        backdrop-blur rounded-lg p-4 min-w-48 theme-panel border
                            transition-all duration-150
                            data-[open=true]:scale-100 data-[open=true]:opacity-100 data-[open=true]:visible">

                    <div class="text-[11px] theme-muted uppercase tracking-wider mb-3">Settings</div>

                <div class="space-y-0.5">
                    <!-- Toggle: Skins -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Skins</span>
                        <div class="relative w-9 h-5">
                            <input id="settingShowSkins" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>

                    <!-- Toggle: Names -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Names</span>
                        <div class="relative w-9 h-5">
                            <input id="settingShowNames" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>

                    <!-- Toggle: Mass -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Mass</span>
                        <div class="relative w-9 h-5">
                            <input id="settingShowMass" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>

                    <!-- Toggle: Grid -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Grid</span>
                        <div class="relative w-9 h-5">
                            <input id="settingShowGrid" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>

                    <!-- Toggle: Background Sectors -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Sectors</span>
                        <div class="relative w-9 h-5">
                            <input id="settingShowBackgroundSectors" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>

                    <!-- Toggle: Minimap -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Minimap</span>
                        <div class="relative w-9 h-5">
                            <input id="settingShowMinimap" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>

                    <!-- Toggle: Dark Theme -->
                    <label class="flex items-center justify-between py-1.5 cursor-pointer group">
                        <span class="text-sm theme-muted">Dark Theme</span>
                        <div class="relative w-9 h-5">
                            <input id="settingDarkTheme" type="checkbox" checked class="toggle-input sr-only">
                            <div class="toggle-track absolute inset-0 rounded-full cursor-pointer transition-colors"></div>
                        </div>
                    </label>
                </div>
            </div>
            </div>
        </div>
        <div class="theme-muted mt-5 text-sm">Rust + WebAssembly Client</div>
    </div>

    <!-- Skin Picker Modal -->
    <div id="skinPickerModal" class="absolute inset-0 theme-overlay hidden z-70">
        <div class="backdrop-blur rounded-lg p-6 theme-panel border max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 class="theme-text text-2xl">Select Skin</h2>
                <button id="closeSkinPicker" class="w-8 h-8 rounded theme-control hover:bg-white/20 flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 fill-white/70" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div id="skinPickerContent" class="flex-1 overflow-hidden">
                <div id="skinPickerLoading" class="text-center py-8 theme-muted">
                    Loading skins...
                </div>
                <div id="skinGrid" class="skin-grid hidden">
                    <!-- Skins will be populated here -->
                </div>
                <div id="skinPickerError" class="text-center py-8 theme-muted hidden">
                    Failed to load skins
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Display -->
    <div id="stats" class="absolute top-2 left-2 text-sm rounded p-2 font-mono hidden theme-panel border">
        <div>FPS: <span id="fps">0</span></div>
        <div>Score: <span id="score">0</span></div>
        <div>Cells: <span id="cellCount">0</span></div>
        <div class="mt-2 pt-2 border-t border-gray-500" id="serverStatsSection" style="display: none;">
            <div id="serverName" class="font-bold"></div>
            <div id="serverPlayers"></div>
            <div id="serverAlive"></div>
            <div id="serverSpectating"></div>
            <div id="serverLoad"></div>
            <div id="serverLatency"></div>
        </div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="absolute top-2 right-2 py-2 px-4 rounded hidden theme-panel border">
        <h3 class="mb-2 text-base">Leaderboard</h3>
        <ol id="leaderboardList" class="list-decimal list-inside text-sm"></ol>
    </div>

    <!-- Chat Box -->
    <div id="chatBox" class="absolute left-2 text-xs rounded p-2 overflow-y-auto theme-panel theme-text border z-40"></div>

    <!-- Chat Input Row (shown on T key press) -->
    <div id="chatInputRow" class="absolute bottom-2 left-2 z-40 flex! gap-2">
        <input type="text" id="chatInput" class="py-2 px-3 border rounded text-xs outline-none font-sans theme-control"
               placeholder="Type a message..." maxlength="128" />
        <button id="chatSend" class="py-2 px-3 rounded text-white text-xs bg-green-500 hover:bg-green-600 transition-colors duration-300">Send</button>
    </div>

    <!-- Mobile Controls -->
    <div id="mobileControls" class="mobile-controls">
        <!-- Right side: Main actions (aligned to left of leaderboard) -->
        <div class="fixed top-2.5 right-55 flex flex-col gap-2">
            <!-- First row: Chat + Menu -->
            <div class="flex gap-2">
                <button id="mobileChat" class="mobile-btn" title="Toggle Chat">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                    </svg>
                </button>
                <button id="mobileMenu" class="mobile-btn" title="Menu (ESC)">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
            </div>
            <!-- Second row: Eject -->
            <div class="flex justify-center">
                <button id="mobileEject" class="mobile-btn" title="Eject Mass (W)">
                    W
                </button>
            </div>
        </div>
        
        <!-- Left side: Minion controls (to the right of stats) -->
        <div class="fixed top-2 left-60">
            <div class="mobile-btn-grid">
                <button id="mobileQ" class="mobile-btn small" title="Q - Freeze Main">Q</button>
                <button id="mobileE" class="mobile-btn small" title="E - Minion Split">E</button>
                <button id="mobileR" class="mobile-btn small" title="R - Minion Eject">R</button>
                <button id="mobileT" class="mobile-btn small" title="T - Freeze Minions">T</button>
                <button id="mobileP" class="mobile-btn small" title="P - Toggle Collection">P</button>
            </div>
        </div>
    </div>

    <!-- Portrait Mode Warning -->
    <div id="portraitWarning" class="fixed inset-0 bg-black/95 hidden z-9999 text-white text-center p-5">
        <svg viewBox="0 0 24 24" fill="white" class="w-20 h-20 mb-5 animate-[rotate-phone_2s_ease-in-out_infinite]">
            <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3.25-3H6.75V4h10.5v14z"/>
        </svg>
        <h2 class="text-2xl font-bold mb-2">Please Rotate Your Device</h2>
        <p class="text-lg opacity-80">This game works best in landscape mode</p>
    </div>

    <!-- Load WASM -->
    <script type="module" src="main.js"></script>
</body>
</html>
